<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Science Exhibition - Project Evaluation</title>
    <style>
        :root {
            --bg: #0b1020;
            --card: #121936;
            --muted: #6b7280;
            --text: #e5e7eb;
            --acc: #7c9cff;
            --good: #22c55e;
            --bad: #ef4444;
            --chip: #1f2a52;
            --chip-border: #2c3a72;
            --border: #232a47;
            --radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto;
            background: linear-gradient(180deg, #0b1020, #0a0f1e 40%);
            color: var(--text);
            min-height: 100vh
        }

        /* Header - Responsive */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            background: #0b1020cc;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(8px);
            z-index: 60;
            flex-wrap: wrap;
            gap: 8px
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 200px
        }

        header img {
            height: 40px;
            width: 40px;
            border-radius: 10px;
            border: 1px solid var(--chip-border);
            object-fit: cover
        }

        header h1 {
            font-size: 16px;
            font-weight: 700;
            line-height: 1.2
        }

        header small {
            display: block;
            color: var(--muted);
            font-size: 12px
        }

        #userControls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap
        }

        .userBadge {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            background: var(--chip);
            border: 1px solid var(--chip-border);
            font-size: 13px;
            color: #c7d2fe;
            white-space: nowrap
        }

        .headerLogout {
            appearance: none;
            border: 1px solid var(--chip-border);
            background: transparent;
            color: var(--muted);
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px
        }

        /* Responsive header for mobile */
        @media (max-width:640px) {
            header {
                padding: 10px 12px
            }

            header h1 {
                font-size: 14px
            }

            header small {
                font-size: 11px
            }

            header img {
                height: 32px;
                width: 32px
            }

            .userBadge {
                font-size: 12px;
                padding: 4px 8px
            }

            .headerLogout {
                padding: 6px 8px;
                font-size: 12px
            }
        }

        /* Container - Responsive */
        .container {
            max-width: 1100px;
            margin: 14px auto;
            padding: 0 16px
        }

        @media (max-width:640px) {
            .container {
                padding: 0 12px;
                margin: 10px auto
            }
        }

        /* Cards */
        .card {
            background: linear-gradient(180deg, #101636, #0d1430);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: 0 10px 28px rgba(0, 0, 0, .25);
            margin-bottom: 12px
        }

        @media (max-width:640px) {
            .card {
                padding: 12px;
                border-radius: 10px
            }
        }

        /* Grid System - Fully Responsive */
        .row {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 12px
        }

        .col-12 {
            grid-column: span 12
        }

        .col-8 {
            grid-column: span 8
        }

        .col-6 {
            grid-column: span 6
        }

        .col-4 {
            grid-column: span 4
        }

        .col-3 {
            grid-column: span 3
        }

        @media (max-width:900px) {
            .col-8 {
                grid-column: span 12
            }
        }

        @media (max-width:768px) {

            .col-6,
            .col-4,
            .col-3 {
                grid-column: span 12
            }
        }

        /* Typography - Responsive */
        h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
            line-height: 1.3
        }

        h3 {
            margin: 6px 0 10px 0;
            font-size: 16px;
            color: #cbd5e1;
            line-height: 1.3
        }

        @media (max-width:640px) {
            h2 {
                font-size: 18px
            }

            h3 {
                font-size: 15px
            }
        }

        /* Form Elements - Responsive */
        label {
            display: block;
            margin: 8px 0 4px;
            color: #c7d2fe;
            font-size: 13px;
            font-weight: 500
        }

        input,
        select,
        textarea {
            width: 100%;
            background: #0e1430;
            border: 1px solid var(--chip-border);
            border-radius: 10px;
            padding: 10px 12px;
            color: var(--text);
            outline: none;
            font-size: 14px;
            font-family: inherit
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--acc)
        }

        textarea {
            min-height: 90px;
            resize: vertical
        }

        @media (max-width:640px) {

            input,
            select,
            textarea {
                padding: 9px 10px;
                font-size: 14px
            }

            label {
                font-size: 12px
            }
        }

        .hint {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
            line-height: 1.4
        }

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            background: var(--chip);
            border: 1px solid var(--chip-border);
            gap: 8px;
            color: #c7d2fe;
            font-size: 12px;
            white-space: nowrap
        }

        /* Buttons - Touch Friendly */
        .btn {
            appearance: none;
            border: 1px solid var(--chip-border);
            background: linear-gradient(180deg, #1c2658, #1a2454);
            color: white;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform .06s ease, opacity .15s;
            font-size: 14px;
            white-space: nowrap;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px)
        }

        .btn:active {
            transform: translateY(0)
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .btn.secondary {
            background: #111834
        }

        .btn.danger {
            background: linear-gradient(180deg, #3a0b14, #2a0a10);
            border-color: #5b111f
        }

        @media (max-width:640px) {
            .btn {
                padding: 10px 12px;
                font-size: 13px;
                min-height: 42px
            }
        }

        /* Toolbar - Responsive */
        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center
        }

        @media (max-width:560px) {
            .toolbar {
                gap: 8px
            }

            .toolbar .btn {
                flex: 1;
                min-width: 120px
            }
        }

        @media (max-width:400px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch
            }

            .toolbar .btn {
                width: 100%;
                min-width: auto
            }
        }

        /* Tables - Responsive */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -16px;
            padding: 0 16px
        }

        @media (max-width:640px) {
            .table-wrapper {
                margin: 0 -12px;
                padding: 0 12px
            }
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            min-width: 600px
        }

        th,
        td {
            text-align: left;
            padding: 10px 12px
        }

        @media (max-width:640px) {

            th,
            td {
                padding: 8px 10px;
                font-size: 13px
            }
        }

        thead th {
            font-size: 12px;
            color: #cbd5e1;
            text-transform: uppercase;
            letter-spacing: .04em
        }

        tbody tr {
            background: #0f1534;
            border: 1px solid var(--border)
        }

        tbody tr td:first-child {
            border-radius: 10px 0 0 10px
        }

        tbody tr td:last-child {
            border-radius: 0 10px 10px 0
        }

        .pill {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid var(--chip-border);
            background: #112055;
            display: inline-block;
            white-space: nowrap
        }

        .error {
            color: var(--bad);
            font-size: 12px;
            margin-top: 4px
        }

        .success {
            color: var(--good)
        }

        .hidden {
            display: none !important
        }

        /* Tabs - Responsive */
        .tabs {
            display: flex;
            gap: 6px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px;
            padding-bottom: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin
        }

        .tabs::-webkit-scrollbar {
            height: 4px
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--chip-border);
            border-radius: 2px
        }

        .tab {
            color: #cbd5e1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            background: #0e1430;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            font-size: 13px;
            min-height: 40px;
            display: inline-flex;
            align-items: center
        }

        .tab.active {
            background: #17204a
        }

        @media (max-width:640px) {
            .tab {
                padding: 8px 10px;
                font-size: 12px
            }
        }

        /* Modal - Responsive */
        .modal-wrap {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: linear-gradient(180deg, rgba(2, 6, 23, 0.85), rgba(2, 6, 23, 0.75));
            z-index: 120;
            overflow-y: auto
        }

        .modal {
            max-width: 920px;
            width: 100%;
            background: #0c122d;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            max-height: 90vh;
            overflow-y: auto
        }

        @media (max-width:768px) {
            .modal-wrap {
                padding: 12px;
                align-items: flex-start
            }

            .modal {
                padding: 14px;
                border-radius: 10px;
                max-height: none;
                margin: 20px 0
            }
        }

        @media (max-width:480px) {
            .modal-wrap {
                padding: 8px
            }

            .modal {
                padding: 12px;
                border-radius: 8px
            }
        }

        /* Progress bar */
        .progressWrap {
            margin-top: 10px
        }

        .progressBar {
            height: 12px;
            background: #0f1534;
            border-radius: 999px;
            border: 1px solid var(--chip-border);
            overflow: hidden
        }

        .progressFill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--acc), #6ad1ff);
            transition: width .35s ease
        }

        .progressText {
            font-size: 13px;
            color: var(--muted);
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap
        }

        @media (max-width:640px) {
            .progressText {
                font-size: 12px
            }
        }

        /* Helpers */
        .small {
            font-size: 12px;
            color: var(--muted)
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--muted)
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--chip-border);
            border-top-color: var(--acc);
            border-radius: 50%;
            animation: spin 0.8s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* Mobile Menu Helper */
        @media (max-width:640px) {
            .mobile-scroll {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="brand">
            <img id="appLogo" alt="logo" src="https://dummyimage.com/128x128/1f2a52/ffffff&text=SE" />
            <div>
                <h1 id="appTitle">Think Big Science Carnival 2025</h1>
                <small id="appSubtitle" class="muted">Project Evaluation System</small>
            </div>
        </div>
        <div id="userControls" aria-hidden="true"></div>
    </header>

    <div class="container">
        <!-- Role Gate -->
        <div id="roleGate" class="card">
            <h2>Choose Portal</h2>
            <p class="muted">Select your role to continue.</p>
            <div class="toolbar" style="margin-top:12px">
                <button class="btn" onclick="UI.show('adminLogin')">Admin Panel</button>
                <button class="btn" onclick="UI.show('evaluatorLogin')">Evaluator Panel</button>
            </div>
        </div>

        <!-- Admin Login -->
        <div id="adminLogin" class="card hidden">
            <h2>Admin Login</h2>
            <div class="row">
                <div class="col-6">
                    <label>Admin Email</label>
                    <input id="adminEmail" placeholder="admin@example.com" />
                </div>
                <div class="col-6">
                    <label>Passcode</label>
                    <input id="adminPass" type="password" placeholder="Enter admin passcode" />
                </div>
            </div>
            <div class="toolbar" style="margin-top:12px">
                <button class="btn" onclick="Auth.adminLogin()">Login</button>
                <button class="btn secondary" onclick="UI.backToGate()">Back</button>
            </div>
            <div id="adminLoginMsg" class="hint"></div>
            <p class="hint" style="margin-top:8px">Default passcode is <b>admin123</b>. Change it in Settings.</p>
        </div>

        <!-- Evaluator Login -->
        <div id="evaluatorLogin" class="card hidden">
            <h2>Evaluator Login</h2>
            <div class="row">
                <div class="col-6">
                    <label>Email</label>
                    <input id="evalEmail" placeholder="you@school.org" />
                </div>
                <div class="col-6">
                    <label>Access Code</label>
                    <input id="evalCode" placeholder="e.g. 742915" />
                </div>
            </div>
            <div class="toolbar" style="margin-top:12px">
                <button class="btn" onclick="Auth.evaluatorLogin()">Login</button>
                <button class="btn secondary" onclick="UI.backToGate()">Back</button>
            </div>
            <div id="evalLoginMsg" class="hint"></div>
        </div>

        <!-- Admin App -->
        <div id="adminApp" class="card hidden">
            <div class="tabs mobile-scroll" id="adminTabs"></div>
            <div id="adminView"></div>
        </div>

        <!-- Evaluator App -->
        <div id="evalApp" class="hidden">
            <div id="evalTop" class="card flex-between">
                <div style="flex:1">
                    <h3 id="welcomeTitle">Welcome to Think Big Science Carnival 2025</h3>
                    <p id="welcomeBody" class="muted">Please review the instructions and enter your basic details to
                        begin.</p>
                </div>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                    <div id="evalBadge" class="userBadge hidden"></div>
                    <button class="headerLogout hidden" id="evalLogoutBtn"
                        onclick="Auth.logoutEvaluator()">Logout</button>
                </div>
            </div>

            <div id="evalWelcome" class="card">
                <p class="muted">Please review the instructions and enter your basic details to begin.</p>
                <div style="margin-top:12px" class="toolbar">
                    <button class="btn" onclick="Eval.showProfileForm()">Enter Your Basic Details</button>
                </div>
            </div>

            <!-- Profile Form -->
            <div id="evalProfile" class="card hidden">
                <h3>Your Details</h3>
                <div class="row">
                    <div class="col-6">
                        <label>Full Name *</label>
                        <input id="profName" />
                    </div>
                    <div class="col-6">
                        <label>Expertise</label>
                        <input id="profExpertise" placeholder="e.g. Robotics, Biology" />
                    </div>
                    <div class="col-12">
                        <label>Notes (optional)</label>
                        <textarea id="profNotes" placeholder="Any additional information"></textarea>
                    </div>
                </div>
                <div class="toolbar" style="margin-top:12px">
                    <button class="btn" onclick="Eval.saveProfile()">Save & Continue</button>
                    <button class="btn secondary" onclick="UI.show('evalWelcome')">Cancel</button>
                </div>
                <div id="profMsg" class="hint"></div>
            </div>

            <!-- Assigned Projects -->
            <div id="evalProjects" class="card hidden">
                <h2>Your Assigned Projects</h2>
                <div class="hint">Select projects to evaluate. When ready click "Proceed to Finalize".</div>

                <!-- Progress bar + counter -->
                <div id="progressArea" class="progressWrap">
                    <div class="progressBar">
                        <div id="progressFill" class="progressFill" style="width:0%"></div>
                    </div>
                    <div id="progressText" class="progressText">
                        <span id="progressCount">0 / 0 completed (0%)</span>
                        <span id="leftCount" class="small">0 left to evaluate</span>
                    </div>
                </div>

                <div class="table-wrapper" style="margin-top:12px">
                    <div id="evalProjectTable"></div>
                </div>

                <!-- Toolbar area -->
                <div id="evalToolbar" style="margin-top:12px" class="toolbar"></div>
            </div>

            <div id="modalContainer"></div>
        </div>
    </div>
    <script>
        /********************
         * GAS Configuration
         ********************/
        const GAS_CONFIG = {
            scriptUrl: '', // Set this in Admin Settings
            enabled: false
        };

        /********************
         * Store + GAS Sync
         ********************/
        const Store = {
            key: 'se_eval_app_v2',
            load() {
                try {
                    const d = JSON.parse(localStorage.getItem(this.key) || '{}');
                    const defaults = {
                        settings: {
                            eventTitle: 'Think Big Science Carnival 2025',
                            subtitle: 'Project Evaluation System',
                            welcomeTitle: 'Welcome to Think Big Science Carnival 2025',
                            welcomeBody: 'Please read the instructions. Click below to enter your basic details and start evaluating assigned projects.',
                            logoUrl: 'https://dummyimage.com/128x128/1f2a52/ffffff&text=SE',
                            adminPass: 'admin123',
                            gasUrl: ''
                        },
                        evaluators: [],
                        projects: [],
                        panels: [],
                        rubricDefs: [
                            { key: 'problem', label: 'Problem Statement Clarity' },
                            { key: 'originality', label: 'Originality' },
                            { key: 'description', label: 'Project Description Quality' },
                            { key: 'method', label: 'Methodology & Design' },
                            { key: 'impact', label: 'Practical Application / Impact' },
                            { key: 'presentation', label: 'Presentation & Q&A' }
                        ],
                        results: [],
                        evaluatorState: {},
                        lastSync: null
                    };
                    return Object.assign(defaults, d);
                } catch (err) {
                    console.error('Error loading data, clearing localStorage:', err);
                    // clear corrupted data and retry once
                    localStorage.removeItem(this.key);
                    const d = {};
                    const defaults = {
                        settings: {
                            eventTitle: 'Think Big Science Carnival 2025',
                            subtitle: 'Project Evaluation System',
                            welcomeTitle: 'Welcome to Think Big Science Carnival 2025',
                            welcomeBody: 'Please read the instructions. Click below to enter your basic details and start evaluating assigned projects.',
                            logoUrl: 'https://dummyimage.com/128x128/1f2a52/ffffff&text=SE',
                            adminEmail: 'admin@example.com',   // ⬅️ NEW
                            adminPass: 'admin123',
                            gasUrl: ''
                        },
                        evaluators: [],
                        projects: [],
                        panels: [],
                        rubricDefs: [
                            { key: 'problem', label: 'Problem Statement Clarity' },
                            { key: 'originality', label: 'Originality' },
                            { key: 'description', label: 'Project Description Quality' },
                            { key: 'method', label: 'Methodology & Design' },
                            { key: 'impact', label: 'Practical Application / Impact' },
                            { key: 'presentation', label: 'Presentation & Q&A' }
                        ],
                        results: [],
                        evaluatorState: {},
                        lastSync: null
                    };
                    return Object.assign(defaults, d);
                }
            },
            save() {
                try {
                    localStorage.setItem(this.key, JSON.stringify(DB));
                    GASSync.autoSync();
                } catch (err) {
                    console.error('Error saving data:', err);
                    alert('Error saving data. Please try again.');
                }
            }
        };
        let DB = Store.load();

        /********************
         * ID Migration - Convert old IDs to new format
         ********************/
        const IDMigration = {
            needsMigration() {
                const hasOldId = (arr) => arr.some(item => item.id && item.id.startsWith('id_'));
                return hasOldId(DB.projects) || hasOldId(DB.evaluators) || hasOldId(DB.panels) || hasOldId(DB.results);
            },
            migrate() {
                console.log('Starting ID migration...');
                const idMap = {
                    projects: {},
                    evaluators: {},
                    panels: {},
                    results: {}
                };
                DB.projects.forEach((p, idx) => {
                    const oldId = p.id;
                    const newId = `PRJ-${String(idx + 1).padStart(4, '0')}`;
                    idMap.projects[oldId] = newId;
                    p.id = newId;
                });
                DB.evaluators.forEach((e, idx) => {
                    const oldId = e.id;
                    const newId = `EVAL-${String(idx + 1).padStart(4, '0')}`;
                    idMap.evaluators[oldId] = newId;
                    e.id = newId;
                });
                DB.panels.forEach((p, idx) => {
                    const oldId = p.id;
                    const newId = `PNL-${String(idx + 1).padStart(4, '0')}`;
                    idMap.panels[oldId] = newId;
                    p.id = newId;
                    p.evaluatorIds = p.evaluatorIds.map(eid => idMap.evaluators[eid] || eid);
                    p.projectIds = p.projectIds.map(pid => idMap.projects[pid] || pid);
                });
                DB.results.forEach((r, idx) => {
                    const oldId = r.id;
                    const newId = `RES-${String(idx + 1).padStart(4, '0')}`;
                    idMap.results[oldId] = newId;
                    r.id = newId;
                    r.panelId = idMap.panels[r.panelId] || r.panelId;
                    r.projectId = idMap.projects[r.projectId] || r.projectId;
                    r.evaluatorId = idMap.evaluators[r.evaluatorId] || r.evaluatorId;
                });
                if (DB.evaluatorState) {
                    const newState = {};
                    for (let oldEvalId in DB.evaluatorState) {
                        const newEvalId = idMap.evaluators[oldEvalId] || oldEvalId;
                        newState[newEvalId] = DB.evaluatorState[oldEvalId];
                    }
                    DB.evaluatorState = newState;
                }
                Store.save();
                console.log('Migration complete!');
                alert('✓ IDs have been migrated to simple format!\n\nProjects: PRJ-0001, PRJ-0002...\nEvaluators: EVAL-0001, EVAL-0002...\nPanels: PNL-0001, PNL-0002...\nResults: RES-0001, RES-0002...\n\nPage will reload now.');
                location.reload();
            }
        };
        if (IDMigration.needsMigration()) {
            IDMigration.migrate();
        }

        /********************
         * GAS Sync Module
         ********************/
        /********************
       * GAS Sync Module
       * - call(): JSON API for production
       * - syncAll(): legacy bulk export (optional)
       ********************/
        const GASSync = {
            async call(action, payload = {}) {
                if (!DB.settings.gasUrl) {
                    throw new Error('Google Apps Script URL is not configured in Settings.');
                }

                const body = {
                    action,
                    ...payload
                };

                const res = await fetch(DB.settings.gasUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    throw new Error('Network error: ' + res.status);
                }

                const data = await res.json();
                if (!data.ok) {
                    throw new Error(data.error || 'Unknown backend error');
                }
                return data;
            },

            // keep your old bulk sync to Sheets for admin export
            async syncAll() {
                if (!DB.settings.gasUrl) {
                    alert('⚠️ Please configure Google Apps Script URL in Admin Settings first.');
                    return { ok: false, error: 'No GAS URL configured' };
                }
                UI.showLoading('Syncing to Google Sheets...');
                try {
                    // use old bulk payload as a “backup/export” only
                    const payload = {
                        type: 'bulk',
                        data: {
                            settings: DB.settings,
                            evaluators: DB.evaluators,
                            projects: DB.projects,
                            panels: DB.panels,
                            results: DB.results,
                            evaluatorState: DB.evaluatorState
                        }
                    };

                    const res = await fetch(DB.settings.gasUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    UI.hideLoading();

                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const data = await res.json();
                    if (!data.ok) throw new Error(data.error || 'Bulk sync error');

                    DB.lastSync = Date.now();
                    localStorage.setItem(Store.key, JSON.stringify(DB));

                    alert('✓ Data sent to Google Sheets successfully!');
                    return data;
                } catch (err) {
                    UI.hideLoading();
                    alert('✗ Sync error: ' + err.message);
                    return { ok: false, error: err.message };
                }
            },

            autoSync() {
                if (DB.settings.gasUrl && DB.lastSync && (Date.now() - DB.lastSync > 300000)) {
                    this.syncAll();
                }
            }
        };


        /********************
         * Utilities
         ********************/
        const U = {
            uid: (type = 'item') => {
                const prefix = {
                    project: 'PRJ',
                    evaluator: 'EVAL',
                    panel: 'PNL',
                    result: 'RES'
                }[type] || 'ID';
                let count = 0;
                if (type === 'project') count = DB.projects.length + 1;
                else if (type === 'evaluator') count = DB.evaluators.length + 1;
                else if (type === 'panel') count = DB.panels.length + 1;
                else if (type === 'result') count = DB.results.length + 1;
                const num = String(count).padStart(4, '0');
                return `${prefix}-${num}`;
            },
            el: (html) => { const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstChild },
            fmtDate: (ts) => new Date(ts).toLocaleString(),
            download(name, obj) {
                const blob = new Blob([typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url);
            },
            csv(rows) {
                const keys = [...new Set(rows.flatMap(r => Object.keys(r)))];
                const esc = (v) => ('' + (v ?? '')).replaceAll('"', '""');
                const out = [keys.join(',')].concat(rows.map(r => keys.map(k => `"${esc(r[k])}"`).join(',')));
                return out.join('\n');
            },
            // NEW: HTML escape to prevent XSS
            escape(str = '') {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }
        };

        /********************
         * UI Module
         ********************/
        const UI = {
            show(id) {
                document.querySelectorAll('.card, #evalApp, #adminApp').forEach(el => {
                    if (el.id === id) el.classList.remove('hidden');
                    else {
                        if (el.id === 'evalApp' && id.startsWith('eval')) el.classList.remove('hidden');
                        else el.classList.add('hidden');
                    }
                });
                if (id === 'evalApp' || id.startsWith('eval')) document.getElementById('evalApp').classList.remove('hidden');
                this.syncBranding();
            },
            backToGate() {
                ['adminEmail', 'adminPass', 'evalEmail', 'evalCode'].forEach(id => { const el = document.getElementById(id); if (el) el.value = '' });
                Auth.currentAdmin = null;
                Auth.currentEval = null;
                document.querySelectorAll('.card, #evalApp, #adminApp').forEach(el => el.classList.add('hidden'));
                document.getElementById('roleGate').classList.remove('hidden');
                this.syncBranding();
            },
            syncBranding() {
                document.getElementById('appTitle').textContent = DB.settings.eventTitle;
                document.getElementById('appSubtitle').textContent = DB.settings.subtitle;
                document.getElementById('appLogo').src = DB.settings.logoUrl || 'https://dummyimage.com/128x128/1f2a52/ffffff&text=SE';
                document.getElementById('welcomeTitle').textContent = DB.settings.welcomeTitle;
                document.getElementById('welcomeBody').textContent = DB.settings.welcomeBody;

                const uc = document.getElementById('userControls'); uc.innerHTML = '';
                if (Auth.currentAdmin) {
                    uc.style.display = 'flex';
                    uc.appendChild(U.el(`<div class="userBadge">Admin: ${U.escape(Auth.currentAdmin.email || '—')}</div>`));
                    const btn = U.el(`<button class="headerLogout">Logout</button>`); btn.onclick = () => Auth.logoutAdmin(); uc.appendChild(btn);
                    return;
                }
                if (Auth.currentEval) {
                    uc.style.display = 'flex';
                    uc.appendChild(U.el(`<div class="userBadge">${U.escape(Auth.currentEval.name || Auth.currentEval.email || 'Evaluator')}</div>`));
                    const btn = U.el(`<button class="headerLogout">Logout</button>`); btn.onclick = () => Auth.logoutEvaluator(); uc.appendChild(btn);
                    const eb = document.getElementById('evalBadge'); if (eb) { eb.textContent = Auth.currentEval.name || Auth.currentEval.email; eb.classList.remove('hidden'); }
                    const ebbtn = document.getElementById('evalLogoutBtn'); if (ebbtn) ebbtn.classList.remove('hidden');
                    return;
                }
                uc.style.display = 'none';
                const eb = document.getElementById('evalBadge'); if (eb) eb.classList.add('hidden');
                const ebbtn = document.getElementById('evalLogoutBtn'); if (ebbtn) ebbtn.classList.add('hidden');
            },
            showLoading(msg = 'Loading...') {
                const existing = document.getElementById('globalLoading');
                if (existing) existing.remove();
                const loader = U.el(`<div id="globalLoading" style="position:fixed;top:70px;right:16px;background:var(--card);border:1px solid var(--border);padding:12px 16px;border-radius:10px;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.3)"><div style="display:flex;align-items:center;gap:10px"><span class="spinner"></span><span>${U.escape(msg)}</span></div></div>`);
                document.body.appendChild(loader);
            },
            hideLoading() {
                const loader = document.getElementById('globalLoading');
                if (loader) loader.remove();
            }
        };

        /********************
         * Auth Module
         ********************/
        const Auth = {
            currentAdmin: null,
            currentEval: null,
            evalToken: null,      // ⬅️ add this
            adminToken: null,     // (for future admin backend login if needed)
            adminLogin() {
                const emailEl = document.getElementById('adminEmail');
                const passEl = document.getElementById('adminPass');
                const msg = document.getElementById('adminLoginMsg');

                const email = emailEl.value.trim();
                const pass = passEl.value.trim();

                msg.textContent = '';
                msg.style.color = 'var(--muted)';

                // 1) Validate email presence + format
                if (!email) {
                    msg.textContent = 'Admin email is required.';
                    msg.style.color = 'var(--bad)';
                    emailEl.focus();
                    return;
                }
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    msg.textContent = 'Please enter a valid email address.';
                    msg.style.color = 'var(--bad)';
                    emailEl.focus();
                    return;
                }

                // 2) Validate passcode presence
                if (!pass) {
                    msg.textContent = 'Passcode is required.';
                    msg.style.color = 'var(--bad)';
                    passEl.focus();
                    return;
                }

                // 3) Compare against settings (case-insensitive email)
                const cfgEmail = (DB.settings.adminEmail || '').trim().toLowerCase();
                const cfgPass = (DB.settings.adminPass || '').trim();

                // If admin has not configured an email yet -> bootstrap mode
                if (!cfgEmail) {
                    if (pass !== cfgPass) {
                        msg.textContent = 'Invalid admin passcode.';
                        msg.style.color = 'var(--bad)';
                        return;
                    }

                    // Allow login using PASS ONLY
                    msg.textContent = '⚠️ First time setup: No admin email configured. Please set it in Settings.';
                    msg.style.color = 'var(--yellow)';

                    this.currentAdmin = { email };
                    UI.show('adminApp');
                    Admin.render();
                    UI.syncBranding();
                    return;
                }


                if (email.toLowerCase() !== cfgEmail || pass !== cfgPass) {
                    msg.textContent = 'Invalid admin email or passcode.';
                    msg.style.color = 'var(--bad)';
                    return;
                }

                // 4) Success → log in admin
                this.currentAdmin = { email };
                UI.show('adminApp');
                Admin.render();
                msg.textContent = '';
                UI.syncBranding();
            },

            logoutAdmin() {
                if (!confirm('Logout admin?')) return;
                this.currentAdmin = null; UI.backToGate();
            },
            logoutEvaluator() {
                if (!confirm('Logout evaluator?')) return;
                this.currentEval = null;
                const n = document.getElementById('profName');
                const e = document.getElementById('profExpertise');
                const no = document.getElementById('profNotes');
                if (n) n.value = '';
                if (e) e.value = '';
                if (no) no.value = '';
                document.getElementById('evalProjectTable').innerHTML = '';
                UI.backToGate();
            }
        };

        /********************
         * Admin Module
         ********************/
        const Admin = {
            tabs: [
                { id: 'scores', label: 'Scores' },
                { id: 'settings', label: 'Settings' },
                { id: 'projects', label: 'Projects' },
                { id: 'evaluators', label: 'Evaluators' },
                { id: 'panels', label: 'Jury Panels' },
                { id: 'data', label: 'Data & Export' }
            ],
            render() {
                const tabs = document.getElementById('adminTabs');
                tabs.innerHTML = '';
                this.tabs.forEach((t, i) => {
                    const b = U.el(`<button class="tab ${i === 0 ? 'active' : ''}" data-id="${t.id}">${U.escape(t.label)}</button>`);
                    b.onclick = (e) => this.switch(e.target.getAttribute('data-id'));
                    tabs.appendChild(b);
                });
                this.switch('scores');
                UI.syncBranding();
            },
            switch(id) {
                document.querySelectorAll('#adminTabs .tab').forEach(tb => tb.classList.remove('active'));
                const targetTab = document.querySelector(`#adminTabs .tab[data-id="${id}"]`);
                if (targetTab) targetTab.classList.add('active');
                const v = document.getElementById('adminView');
                this[id](v);
                UI.syncBranding();
            },

            /* SCORES */
            scores(host) {
                const projectScores = DB.projects.map(project => {
                    const projectResults = DB.results.filter(r => r.projectId === project.id);
                    if (projectResults.length === 0) {
                        return {
                            id: project.id,
                            title: project.title,
                            category: project.category || '—',
                            team: project.team || '—',
                            school: project.school || '—',
                            evaluatorCount: 0,
                            totalScore: 0,
                            averageScore: 0,
                            maxPossible: DB.rubricDefs.length * 10,
                            percentage: 0,
                            evaluators: []
                        };
                    }
                    const totalScore = projectResults.reduce((sum, r) => sum + (r.total || 0), 0);
                    const averageScore = totalScore / projectResults.length;
                    const maxPossible = DB.rubricDefs.length * 10;
                    const percentage = (averageScore / maxPossible) * 100;
                    const evaluators = projectResults.map(r => {
                        const evaluator = DB.evaluators.find(e => e.id === r.evaluatorId);
                        return {
                            name: evaluator?.name || evaluator?.email || 'Unknown',
                            score: r.total || 0,
                            finalized: r.finalizedByEvaluator
                        };
                    });
                    return {
                        id: project.id,
                        title: project.title,
                        category: project.category || '—',
                        team: project.team || '—',
                        school: project.school || '—',
                        evaluatorCount: projectResults.length,
                        totalScore: totalScore,
                        averageScore: averageScore,
                        maxPossible: maxPossible,
                        percentage: percentage,
                        evaluators: evaluators
                    };
                });

                projectScores.sort((a, b) => b.averageScore - a.averageScore);

                const rows = projectScores.map((ps, index) => {
                    const isTop5 = index < 5 && ps.evaluatorCount > 0;
                    const rowStyle = isTop5 ? 'background: linear-gradient(90deg, #1a2454, #0f1534); border-left: 4px solid #7c9cff;' : '';
                    const badge = isTop5 ? `<span class="pill" style="background:#7c9cff;color:#000;font-weight:700">TOP ${index + 1}</span>` : '';
                    return `<tr style="${rowStyle}">
          <td>
            ${badge}
            ${badge ? '<br>' : ''}
            <b>${U.escape(ps.title)}</b>
            <div class="hint" style="margin-top:4px">${U.escape(ps.category)}</div>
          </td>
          <td>${U.escape(ps.team)}<div class="hint">${U.escape(ps.school)}</div></td>
          <td style="text-align:center">
            <span class="pill">${ps.evaluatorCount} evaluator${ps.evaluatorCount !== 1 ? 's' : ''}</span>
          </td>
          <td style="text-align:right">
            <b style="font-size:18px;color:${isTop5 ? 'var(--acc)' : 'inherit'}">${ps.averageScore.toFixed(2)}</b>
            <div class="hint">out of ${ps.maxPossible}</div>
          </td>
          <td style="text-align:right">
            <b style="font-size:16px;color:${ps.percentage >= 80 ? 'var(--good)' : ps.percentage >= 60 ? '#fbbf24' : 'inherit'}">${ps.percentage.toFixed(1)}%</b>
          </td>
          <td>
            <button class="btn" onclick="Admin.viewProjectDetails('${ps.id}')">View Details</button>
          </td>
        </tr>`;
                }).join('');

                const evaluatedProjects = projectScores.filter(ps => ps.evaluatorCount > 0);
                const avgScore = evaluatedProjects.length > 0
                    ? (evaluatedProjects.reduce((sum, ps) => sum + ps.averageScore, 0) / evaluatedProjects.length).toFixed(2)
                    : '—';

                const summary = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px">
          <div class="card" style="background:#1a2454">
            <div class="hint">Total Projects</div>
            <div style="font-size:28px;font-weight:700;margin-top:4px">${DB.projects.length}</div>
          </div>
          <div class="card" style="background:#1a2454">
            <div class="hint">Projects Evaluated</div>
            <div style="font-size:28px;font-weight:700;margin-top:4px">${evaluatedProjects.length}</div>
          </div>
          <div class="card" style="background:#1a2454">
            <div class="hint">Total Evaluations</div>
            <div style="font-size:28px;font-weight:700;margin-top:4px">${DB.results.length}</div>
          </div>
          <div class="card" style="background:#1a2454">
            <div class="hint">Average Score</div>
            <div style="font-size:28px;font-weight:700;margin-top:4px">${avgScore}</div>
          </div>
        </div>
      `;

                host.innerHTML = `
        ${summary}
        <div class="card">
          <div class="flex-between" style="margin-bottom:12px">
            <h3>Project Scores (Ranked by Average)</h3>
            <div class="toolbar">
              <button class="btn" onclick="Admin.exportScores()">Export Scores</button>
              <button class="btn danger" onclick="Admin.clearScores()">Clear All Scores</button>
              <button class="btn secondary" onclick="Admin.refreshScores()">Refresh</button>
            </div>
          </div>
          <div class="hint" style="margin-bottom:12px">
            Top 5 projects are highlighted. Scores are averaged from all evaluator submissions.
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Team</th>
                  <th>Evaluations</th>
                  <th style="text-align:right">Avg Score</th>
                  <th style="text-align:right">Percentage</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${rows || '<tr><td colspan="6" class="muted" style="text-align:center;padding:20px">No projects or evaluations yet.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
            },

            viewProjectDetails(projectId) {
                const project = DB.projects.find(p => p.id === projectId);
                if (!project) {
                    alert('Project not found');
                    return;
                }
                const projectResults = DB.results.filter(r => r.projectId === projectId);
                if (projectResults.length === 0) {
                    alert('No evaluations found for this project');
                    return;
                }
                const rubricAggregates = {};
                DB.rubricDefs.forEach(def => {
                    const scores = projectResults.map(r => r.scores?.[def.key] || 0);
                    const sum = scores.reduce((a, b) => a + b, 0);
                    const avg = sum / scores.length;
                    rubricAggregates[def.key] = {
                        label: def.label,
                        scores: scores,
                        average: avg,
                        max: 10
                    };
                });

                const totalAvg = Object.values(rubricAggregates).reduce((sum, agg) => sum + agg.average, 0);
                const maxTotal = DB.rubricDefs.length * 10;
                const percentage = (totalAvg / maxTotal) * 100;

                const evaluatorRows = projectResults.map(r => {
                    const evaluator = DB.evaluators.find(e => e.id === r.evaluatorId);
                    const evalName = evaluator?.name || evaluator?.email || 'Unknown';
                    const scoreBreakdown = DB.rubricDefs.map(def =>
                        `<div style="margin:4px 0"><span class="hint">${U.escape(def.label)}:</span> <b>${U.escape(String(r.scores?.[def.key] || 0))}</b>/10</div>`
                    ).join('');
                    return `
          <div class="card" style="margin-bottom:10px">
            <div class="flex-between">
              <div>
                <b>${U.escape(evalName)}</b>
                ${r.finalizedByEvaluator ? '<span class="pill success" style="margin-left:8px">✓ Finalized</span>' : '<span class="pill" style="margin-left:8px">Draft</span>'}
              </div>
              <div style="text-align:right">
                <div style="font-size:20px;font-weight:700">${U.escape(String(r.total || 0))}</div>
                <div class="hint">out of ${maxTotal}</div>
              </div>
            </div>
            <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">
              ${scoreBreakdown}
            </div>
            ${r.remark ? `<div style="margin-top:12px;padding:10px;background:#0e1430;border-radius:8px;border:1px solid var(--chip-border)"><div class="hint">Remark:</div>${U.escape(r.remark)}</div>` : ''}
          </div>
        `;
                }).join('');

                const aggregateTable = `
        <table>
          <thead>
            <tr>
              <th>Criterion</th>
              <th style="text-align:right">Average Score</th>
              <th style="text-align:right">Individual Scores</th>
            </tr>
          </thead>
          <tbody>
            ${DB.rubricDefs.map(def => {
                    const agg = rubricAggregates[def.key];
                    return `<tr>
                <td>${U.escape(agg.label)}</td>
                <td style="text-align:right"><b style="font-size:16px">${agg.average.toFixed(2)}</b> / 10</td>
                <td style="text-align:right">${agg.scores.map(s => U.escape(String(s))).join(', ')}</td>
              </tr>`;
                }).join('')}
            <tr style="background:#1a2454;font-weight:700">
              <td>TOTAL</td>
              <td style="text-align:right;font-size:18px;color:var(--acc)">${totalAvg.toFixed(2)} / ${maxTotal}</td>
              <td style="text-align:right;font-size:16px">${percentage.toFixed(1)}%</td>
            </tr>
          </tbody>
        </table>
      `;

                const dlg = U.el(`
        <div class="modal-wrap">
          <div class="modal" style="max-width:1100px">
            <h2>${U.escape(project.title)}</h2>
            <div class="hint" style="margin-bottom:16px">
              <b>Team:</b> ${U.escape(project.team || '—')} | <b>School:</b> ${U.escape(project.school || '—')} | <b>Category:</b> ${U.escape(project.category || '—')}
            </div>
            <h3 style="margin-top:20px">Score Summary</h3>
            <div class="card">
              ${aggregateTable}
            </div>
            <h3 style="margin-top:20px">Individual Evaluations (${projectResults.length})</h3>
            ${evaluatorRows}
            <div class="toolbar" style="margin-top:16px">
              <button class="btn secondary" id="closeDetails">Close</button>
            </div>
          </div>
        </div>
      `);
                document.body.appendChild(dlg);
                dlg.querySelector('#closeDetails').onclick = () => dlg.remove();
            },

            exportScores() {
                const projectScores = DB.projects.map(project => {
                    const projectResults = DB.results.filter(r => r.projectId === project.id);
                    if (projectResults.length === 0) {
                        return {
                            'Project ID': project.id,
                            'Project Title': project.title,
                            'Category': project.category || '',
                            'Team': project.team || '',
                            'School': project.school || '',
                            'Number of Evaluators': 0,
                            'Average Score': 0,
                            'Max Possible': DB.rubricDefs.length * 10,
                            'Percentage': 0
                        };
                    }
                    const totalScore = projectResults.reduce((sum, r) => sum + (r.total || 0), 0);
                    const averageScore = totalScore / projectResults.length;
                    const maxPossible = DB.rubricDefs.length * 10;
                    const percentage = (averageScore / maxPossible) * 100;
                    return {
                        'Project ID': project.id,
                        'Project Title': project.title,
                        'Category': project.category || '',
                        'Team': project.team || '',
                        'School': project.school || '',
                        'Number of Evaluators': projectResults.length,
                        'Average Score': averageScore.toFixed(2),
                        'Max Possible': maxPossible,
                        'Percentage': percentage.toFixed(1) + '%'
                    };
                });

                projectScores.sort((a, b) => parseFloat(b['Average Score']) - parseFloat(a['Average Score']));
                U.download('project_scores.csv', U.csv(projectScores));
                alert('✓ Scores exported successfully!');
            },

            refreshScores() {
                this.scores(document.getElementById('adminView'));
            },

            clearScores() {
                if (!confirm('⚠️ WARNING: This will delete ALL evaluation scores and results.\n\nProjects, evaluators, and panels will remain intact.\n\nProceed with deleting all scores?')) return;
                if (!confirm('⚠️ FINAL CONFIRMATION\n\nDelete all evaluation results?\n\nThis cannot be undone!')) return;
                DB.results = [];
                DB.evaluatorState = {};
                Store.save();
                alert('✓ All scores have been cleared successfully.\n\nProjects, evaluators, and panels are still available.\n\nEvaluators can now start fresh evaluations.');
                this.scores(document.getElementById('adminView'));
            },

            /* SETTINGS */
            settings(host) {
                const syncStatus = DB.lastSync ? `Last synced: ${U.fmtDate(DB.lastSync)}` : 'Never synced';
                host.innerHTML = `
        <div class="row">
          <div class="col-6 card">
            <h3>Branding & Content</h3>
            <label>Event Title</label>
            <input id="setEventTitle" value="${U.escape(DB.settings.eventTitle)}">
            <label>Subtitle</label>
            <input id="setSubtitle" value="${U.escape(DB.settings.subtitle)}">
            <label>Logo URL</label>
            <input id="setLogo" value="${U.escape(DB.settings.logoUrl)}">
            <label>Welcome Title</label>
            <input id="setWelcomeTitle" value="${U.escape(DB.settings.welcomeTitle)}">
            <label>Welcome Body</label>
            <textarea id="setWelcomeBody">${U.escape(DB.settings.welcomeBody)}</textarea>
            <div class="toolbar" style="margin-top:10px">
              <button class="btn" onclick="Admin.saveSettings()">Save</button>
              <button class="btn secondary" onclick="Admin.resetBranding()">Reset Defaults</button>
            </div>
          </div>

          <div class="col-6 card">
            <h3>Security & GAS Integration</h3>

<label>Admin Email</label>
<input id="setAdminEmail" type="email" value="${DB.settings.adminEmail || ''}" placeholder="admin@example.com">

<label>Admin Passcode</label>
<input id="setAdminPass" type="password" value="${DB.settings.adminPass}">

<label>Google Apps Script Web App URL</label>
<input id="setGasUrl" placeholder="https://script.google.com/macros/s/.../exec" value="${DB.settings.gasUrl || ''}">

            
            <h3 style="margin-top:20px">System Tools</h3>
            <div class="hint">Use these tools to manage your system data.</div>
            <div class="toolbar" style="margin-top:10px">
              <button class="btn secondary" onclick="Admin.migrateIDs()">Fix IDs to Simple Format</button>
              <button class="btn danger" onclick="Admin.resetAllData()">Reset All Data</button>
            </div>
          </div>
        </div>
      `;
            },
            saveSettings() {
                DB.settings.eventTitle = document.getElementById('setEventTitle').value.trim();
                DB.settings.subtitle = document.getElementById('setSubtitle').value.trim();
                DB.settings.logoUrl = document.getElementById('setLogo').value.trim();
                DB.settings.welcomeTitle = document.getElementById('setWelcomeTitle').value.trim();
                DB.settings.welcomeBody = document.getElementById('setWelcomeBody').value.trim();
                DB.settings.adminEmail = document.getElementById('setAdminEmail').value.trim();
                DB.settings.adminPass = document.getElementById('setAdminPass').value.trim();
                DB.settings.gasUrl = document.getElementById('setGasUrl').value.trim();
                Store.save();
                UI.syncBranding();
                alert('✓ Settings saved!');
            },

            resetBranding() {
                if (!confirm('Reset all branding to defaults?')) return;
                DB.settings.eventTitle = 'Think Big Science Carnival 2025';
                DB.settings.subtitle = 'Project Evaluation System';
                DB.settings.logoUrl = 'https://dummyimage.com/128x128/1f2a52/ffffff&text=SE';
                DB.settings.welcomeTitle = 'Welcome to Think Big Science Carnival 2025';
                DB.settings.welcomeBody = 'Please read the instructions. Click below to enter your basic details and start evaluating assigned projects.';
                Store.save(); this.settings(document.getElementById('adminView')); UI.syncBranding();
            },

            resetAllData() {
                if (!confirm('⚠️ WARNING: This will permanently delete ALL DATA including:\n\n• All Projects\n• All Evaluators\n• All Panels\n• All Evaluation Results\n• All Scores\n\nThis action CANNOT be undone!\n\nClick OK to proceed with deletion.')) return;
                if (!confirm('⚠️ FINAL CONFIRMATION\n\nAre you absolutely sure you want to delete everything?\n\nThis is your last chance to cancel!')) return;
                DB.evaluators = [];
                DB.projects = [];
                DB.panels = [];
                DB.results = [];
                DB.evaluatorState = {};
                Store.save();
                alert('✓ All data has been deleted successfully.\n\nThe system has been reset to empty state.\n\nYou can now add new projects, evaluators, and panels.');
                this.switch('scores');
            },

            /* PROJECTS */
            projects(host) {
                const list = DB.projects.map(p => `
        <tr>
          <td><b>${U.escape(p.title)}</b><div class="hint">${U.escape(p.category || '')}</div></td>
          <td>${U.escape(p.team || '')}</td>
          <td>${U.escape(p.school || '')}</td>
          <td>${U.escape(p.contact || '')}</td>
          <td>
            <div class="toolbar">
              <button class="btn" onclick="Admin.editProject('${p.id}')">Edit</button>
              <button class="btn danger" onclick="Admin.deleteProject('${p.id}')">Delete</button>
            </div>
          </td>
        </tr>`).join('');

                host.innerHTML = `
        <div class="toolbar" style="margin-bottom:10px">
          <button class="btn" onclick="Admin.editProject()">Add Project</button>
        </div>
        <div class="card">
          <h3>Projects (${DB.projects.length})</h3>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Project</th><th>Team</th><th>School</th><th>Contact</th><th>Actions</th></tr></thead>
              <tbody>${list || '<tr><td colspan="5" class="muted" style="text-align:center;padding:20px">No projects yet.</td></tr>'}</tbody>
            </table>
          </div>
        </div>
      `;
            },
            editProject(id) {
                const p = id ? DB.projects.find(x => x.id === id) : { id: U.uid('project'), title: '', category: '', team: '', school: '', contact: '' };
                const dlg = U.el(`
        <div class="modal-wrap">
          <div class="modal">
            <h3>${id ? 'Edit' : 'Add'} Project</h3>
            <div class="hint" style="margin-bottom:12px">ID: <b>${U.escape(p.id)}</b></div>
            <label>Title *</label><input id="p_title" value="${U.escape(p.title)}">
            <label>Category</label><input id="p_cat" value="${U.escape(p.category)}" placeholder="e.g. IoT, AI/ML, Environment">
            <label>Team Name</label><input id="p_team" value="${U.escape(p.team)}">
            <label>School</label><input id="p_school" value="${U.escape(p.school)}">
            <label>Contact</label><input id="p_contact" value="${U.escape(p.contact)}" placeholder="email or phone">
            <div class="toolbar" style="margin-top:12px">
              <button class="btn" id="saveBtn">Save</button>
              <button class="btn secondary" id="cancelBtn">Cancel</button>
            </div>
          </div>
        </div>`);
                document.body.appendChild(dlg);
                dlg.querySelector('#cancelBtn').onclick = () => dlg.remove();
                dlg.querySelector('#saveBtn').onclick = () => {
                    p.title = dlg.querySelector('#p_title').value.trim();
                    p.category = dlg.querySelector('#p_cat').value.trim();
                    p.team = dlg.querySelector('#p_team').value.trim();
                    p.school = dlg.querySelector('#p_school').value.trim();
                    p.contact = dlg.querySelector('#p_contact').value.trim();
                    if (!p.title) { alert('Title is required'); return }
                    if (!id) DB.projects.push(p);
                    Store.save(); dlg.remove(); Admin.projects(document.getElementById('adminView'));
                };
                dlg.querySelector('#p_title').focus();
            },
            deleteProject(id) {
                if (!confirm('Delete this project? This will also remove it from all panels.')) return;
                DB.projects = DB.projects.filter(p => p.id !== id);
                DB.panels.forEach(pa => pa.projectIds = pa.projectIds.filter(pid => pid !== id));
                Store.save(); this.projects(document.getElementById('adminView'));
            },

            /* EVALUATORS */
            evaluators(host) {
                const list = DB.evaluators.map(e => `
        <tr>
          <td><b>${U.escape(e.name || '(no name)')}</b><div class="hint">${U.escape(e.email)}</div></td>
          <td>${U.escape(e.expertise || '—')}</td>
          <td><span class="pill">Code: ${U.escape(String(e.code))}</span></td>
          <td>
            <div class="toolbar">
              <button class="btn" onclick="Admin.editEvaluator('${e.id}')">Edit</button>
              <button class="btn danger" onclick="Admin.deleteEvaluator('${e.id}')">Delete</button>
            </div>
          </td>
        </tr>`).join('');

                host.innerHTML = `
        <div class="toolbar" style="margin-bottom:10px">
          <button class="btn" onclick="Admin.bulkAddEvaluators()">Quick Add (CSV)</button>
          <button class="btn" onclick="Admin.editEvaluator()">Add Evaluator</button>
        </div>
        <div class="card">
          <h3>Evaluators (${DB.evaluators.length})</h3>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Evaluator</th><th>Expertise</th><th>Access Code</th><th>Actions</th></tr></thead>
              <tbody>${list || '<tr><td colspan="4" class="muted" style="text-align:center;padding:20px">No evaluators yet.</td></tr>'}</tbody>
            </table>
          </div>
        </div>
      `;
            },
            editEvaluator(id) {
                const e = id ? DB.evaluators.find(x => x.id === id) : { id: U.uid('evaluator'), name: '', email: '', expertise: '', notes: '', code: Math.floor(100000 + Math.random() * 900000) };
                const dlg = U.el(`
        <div class="modal-wrap">
          <div class="modal">
            <h3>${id ? 'Edit' : 'Add'} Evaluator</h3>
            <div class="hint" style="margin-bottom:12px">ID: <b>${U.escape(e.id)}</b></div>
            <label>Name *</label><input id="e_name" value="${U.escape(e.name)}">
            <label>Email *</label><input id="e_email" value="${U.escape(e.email)}" type="email">
            <label>Expertise</label><input id="e_ex" value="${U.escape(e.expertise)}" placeholder="e.g. Robotics, AI">
            <label>Access Code</label><input id="e_code" value="${U.escape(String(e.code))}">
            <label>Notes</label><textarea id="e_notes">${U.escape(e.notes || '')}</textarea>
            <div class="toolbar" style="margin-top:12px">
              <button class="btn" id="saveBtn">Save</button>
              <button class="btn secondary" id="cancelBtn">Cancel</button>
            </div>
          </div>
        </div>`);
                document.body.appendChild(dlg);
                dlg.querySelector('#cancelBtn').onclick = () => dlg.remove();
                dlg.querySelector('#saveBtn').onclick = () => {
                    e.name = dlg.querySelector('#e_name').value.trim();
                    e.email = dlg.querySelector('#e_email').value.trim();
                    e.expertise = dlg.querySelector('#e_ex').value.trim();
                    e.code = dlg.querySelector('#e_code').value.trim();
                    e.notes = dlg.querySelector('#e_notes').value.trim();
                    if (!e.email) { alert('Email required'); return }
                    if (!e.name) { alert('Name required'); return }
                    if (!id) DB.evaluators.push(e);
                    Store.save(); dlg.remove(); Admin.evaluators(document.getElementById('adminView'));
                };
                dlg.querySelector('#e_name').focus();
            },
            deleteEvaluator(id) {
                if (!confirm('Delete this evaluator? This will also remove them from all panels.')) return;
                DB.evaluators = DB.evaluators.filter(e => e.id !== id);
                DB.panels.forEach(pa => pa.evaluatorIds = pa.evaluatorIds.filter(eid => eid !== id));
                Store.save(); this.evaluators(document.getElementById('adminView'));
            },
            bulkAddEvaluators() {
                const sample = 'name,email,expertise\nJane Doe,jane@ex.com,Robotics\nJohn Smith,john@ex.com,Biology';
                const text = prompt('Paste CSV with columns: name,email,expertise\n\nExample:\n' + sample, '');
                if (!text) return;
                const lines = text.split(/\r?\n/).filter(Boolean);
                if (lines.length < 2) { alert('Need at least header + 1 data row'); return }
                const head = lines.shift().split(',').map(h => h.trim());
                let added = 0;
                lines.forEach(line => {
                    const cols = line.split(',');
                    if (cols.length < 2) return;
                    const e = { id: U.uid('evaluator'), code: Math.floor(100000 + Math.random() * 900000), notes: '' };
                    head.forEach((h, i) => e[h] = cols[i]?.trim() || '');
                    if (e.email) {
                        DB.evaluators.push(e);
                        added++;
                    }
                });
                Store.save();
                alert(`Added ${added} evaluators`);
                this.evaluators(document.getElementById('adminView'));
            },

            /* PANELS */
            panels(host) {
                const list = DB.panels.map(pa => {
                    const evaluators = pa.evaluatorIds.map(id => DB.evaluators.find(e => e.id === id)).filter(e => e);
                    const projects = pa.projectIds.map(id => DB.projects.find(p => p.id === id)).filter(p => p);
                    const evalNames = evaluators.map(e => e.name || e.email).join(', ');
                    const projTitles = projects.map(p => p.title).join(', ');
                    const evalCount = evaluators.length;
                    const projCount = projects.length;
                    return `<tr>
          <td>
            <b>${U.escape(pa.name)}</b>
            <div class="hint" style="margin-top:4px">${U.escape(pa.id)}</div>
          </td>
          <td>
            <span class="pill">${evalCount} member${evalCount !== 1 ? 's' : ''}</span>
            <div class="hint" style="margin-top:4px">${evalNames ? U.escape(evalNames) : '<span class="muted">none</span>'}</div>
          </td>
          <td>
            <span class="pill">${projCount} project${projCount !== 1 ? 's' : ''}</span>
            <div class="hint" style="margin-top:4px">${projTitles ? U.escape(projTitles) : '<span class="muted">none</span>'}</div>
          </td>
          <td>
            <div class="toolbar">
              <button class="btn" onclick="Admin.editPanel('${pa.id}')">Edit</button>
              <button class="btn danger" onclick="Admin.deletePanel('${pa.id}')">Delete</button>
            </div>
          </td>
        </tr>`;
                }).join('');

                host.innerHTML = `
        <div class="toolbar" style="margin-bottom:10px">
          <button class="btn" onclick="Admin.editPanel()">Create Panel</button>
        </div>
        <div class="card">
          <h3>Jury Panels (${DB.panels.length})</h3>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Panel</th><th>Evaluators</th><th>Projects</th><th>Actions</th></tr></thead>
              <tbody>${list || '<tr><td colspan="4" class="muted" style="text-align:center;padding:20px">No panels yet.</td></tr>'}</tbody>
            </table>
          </div>
        </div>
      `;
            },
            editPanel(id) {
                const pa = id ? DB.panels.find(x => x.id === id) : { id: U.uid('panel'), name: 'Panel ' + (DB.panels.length + 1), evaluatorIds: [], projectIds: [] };
                const evalOpts = DB.evaluators.map(e => `<label class="chip" style="cursor:pointer"><input type="checkbox" data-eid value="${U.escape(e.id)}" style="width:auto;margin-right:6px"> ${U.escape(e.name || e.email)}</label>`).join(' ');
                const projOpts = DB.projects.map(p => `<label class="chip" style="cursor:pointer"><input type="checkbox" data-pid value="${U.escape(p.id)}" style="width:auto;margin-right:6px"> ${U.escape(p.title)}</label>`).join(' ');
                const dlg = U.el(`
        <div class="modal-wrap">
          <div class="modal">
            <h3>${id ? 'Edit' : 'Create'} Jury Panel</h3>
            <div class="hint" style="margin-bottom:12px">ID: <b>${U.escape(pa.id)}</b></div>
            <label>Panel Name</label><input id="pa_name" value="${U.escape(pa.name)}">
            <label>Evaluators (select 3–4) *</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px">${evalOpts || '<div class="muted">Add evaluators first.</div>'}</div>
            <label style="margin-top:10px">Projects to Evaluate *</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px">${projOpts || '<div class="muted">Add projects first.</div>'}</div>
            <div class="toolbar" style="margin-top:12px">
              <button class="btn" id="saveBtn">Save Panel</button>
              <button class="btn secondary" id="cancelBtn">Cancel</button>
            </div>
          </div>
        </div>`);
                document.body.appendChild(dlg);
                dlg.querySelectorAll('[data-eid]').forEach(ch => { ch.checked = pa.evaluatorIds.includes(ch.value) });
                dlg.querySelectorAll('[data-pid]').forEach(ch => { ch.checked = pa.projectIds.includes(ch.value) });
                dlg.querySelector('#cancelBtn').onclick = () => dlg.remove();
                dlg.querySelector('#saveBtn').onclick = () => {
                    pa.name = dlg.querySelector('#pa_name').value.trim() || pa.name;
                    pa.evaluatorIds = [...dlg.querySelectorAll('[data-eid]:checked')].map(x => x.value);
                    pa.projectIds = [...dlg.querySelectorAll('[data-pid]:checked')].map(x => x.value);
                    if (pa.evaluatorIds.length < 3 || pa.evaluatorIds.length > 4) { alert('Select 3–4 evaluators for a jury panel.'); return }
                    if (pa.projectIds.length === 0) { alert('Assign at least one project.'); return }
                    if (!id) DB.panels.push(pa);
                    Store.save(); dlg.remove(); Admin.panels(document.getElementById('adminView'));
                };
            },
            deletePanel(id) {
                if (!confirm('Delete this panel?')) return;
                DB.panels = DB.panels.filter(p => p.id !== id);
                Store.save(); this.panels(document.getElementById('adminView'));
            },

            /* DATA */
            data(host) {
                const rows = DB.results.map(r => ({
                    id: r.id,
                    panel: DB.panels.find(p => p.id === r.panelId)?.name || '—',
                    project: DB.projects.find(p => p.id === r.projectId)?.title || '—',
                    evaluator: DB.evaluators.find(e => e.id === r.evaluatorId)?.name || '—',
                    total: r.total,
                    remark: r.remark,
                    finalized: r.finalizedByEvaluator ? 'Yes' : 'No',
                    time: U.fmtDate(r.ts),
                    ...r.scores
                }));
                host.innerHTML = `
        <div class="toolbar" style="margin-bottom:10px">
          <button class="btn" onclick='U.download("results.json", DB.results)'>Download JSON</button>
          <button class="btn" onclick='U.download("results.csv", U.csv(${JSON.stringify(rows)}))'>Download CSV</button>
          <button class="btn" onclick="GASSync.syncAll()">Sync to Google Sheets</button>
        </div>
        <div class="card">
          <h3>Evaluation Results (${DB.results.length})</h3>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>ID</th><th>Panel</th><th>Project</th><th>Evaluator</th><th>Total</th><th>Finalized</th><th>Time</th></tr></thead>
              <tbody>
                ${rows.map(r => `<tr>
                  <td>${U.escape(r.id.slice(0, 8))}</td>
                  <td>${U.escape(r.panel)}</td>
                  <td>${U.escape(r.project)}</td>
                  <td>${U.escape(r.evaluator)}</td>
                  <td><b>${U.escape(String(r.total))}</b></td>
                  <td>${U.escape(r.finalized)}</td>
                  <td class="small">${U.escape(r.time)}</td>
                </tr>`).join('') || '<tr><td colspan="7" class="muted" style="text-align:center;padding:20px">No submissions yet.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
            },

            migrateIDs() {
                if (!confirm('This will convert all IDs to simple format (PRJ-0001, EVAL-0001, etc.)\n\nContinue?')) return;
                IDMigration.migrate();
            }
        };

        /********************
         * Evaluator Module
         ********************/
        const Eval = {
            currentProject: null,
            draft: null,

            showProfileForm() {
                UI.show('evalProfile');
                const ev = Auth.currentEval;
                if (ev) {
                    document.getElementById('profName').value = ev.name || '';
                    document.getElementById('profExpertise').value = ev.expertise || '';
                    document.getElementById('profNotes').value = ev.notes || '';
                }
            },

            saveProfile() {
                const name = document.getElementById('profName').value.trim();
                const expertise = document.getElementById('profExpertise').value.trim();
                const notes = document.getElementById('profNotes').value.trim();
                if (!name) {
                    const m = document.getElementById('profMsg');
                    m.textContent = 'Name is required.';
                    m.style.color = 'var(--bad)';
                    return;
                }
                Auth.currentEval.name = name;
                Auth.currentEval.expertise = expertise;
                Auth.currentEval.notes = notes;
                const idx = DB.evaluators.findIndex(e => e.id === Auth.currentEval.id);
                if (idx >= 0) DB.evaluators[idx] = Auth.currentEval;
                Store.save();
                this.goToAssigned();
                UI.syncBranding();
            },

            _evaluatorFinalized() {
                return (DB.evaluatorState && DB.evaluatorState[Auth.currentEval.id] && DB.evaluatorState[Auth.currentEval.id].finalizedAll) === true;
            },

            goToAssigned() {
                UI.show('evalProjects');
                const myPanels = DB.panels.filter(p => p.evaluatorIds.includes(Auth.currentEval.id));
                const myProjectIds = [...new Set(myPanels.flatMap(p => p.projectIds))];
                const total = myProjectIds.length;
                const completed = DB.results.filter(r => r.evaluatorId === Auth.currentEval.id && myProjectIds.includes(r.projectId)).length;
                const left = Math.max(0, total - completed);
                const pct = total === 0 ? 0 : Math.round((completed / total) * 100);

                document.getElementById('progressFill').style.width = pct + '%';
                document.getElementById('progressCount').textContent = `${completed} / ${total} completed (${pct}%)`;
                document.getElementById('leftCount').textContent = `${left} left to evaluate`;

                const rows = myProjectIds.map(pid => {
                    const p = DB.projects.find(x => x.id === pid) || { title: '(missing)' };
                    const submitted = DB.results.find(r => r.projectId === pid && r.evaluatorId === Auth.currentEval.id);
                    if (submitted) {
                        return `<tr>
            <td><b>${U.escape(p.title)}</b><div class="hint">${U.escape(p.category || '')}</div></td>
            <td>${U.escape(p.team || '—')}</td>
            <td>${U.escape(p.school || '—')}</td>
            <td><span class="pill success">Submitted</span></td>
            <td>
              <div class="toolbar">
                <button class="btn" onclick="Eval.openViewOnlyModalByProject('${pid}')">View</button>
              </div>
            </td>
          </tr>`;
                    } else {
                        return `<tr>
            <td><b>${U.escape(p.title)}</b><div class="hint">${U.escape(p.category || '')}</div></td>
            <td>${U.escape(p.team || '—')}</td>
            <td>${U.escape(p.school || '—')}</td>
            <td><span class="pill">Pending</span></td>
            <td>
              <div class="toolbar">
                <button class="btn" onclick="Eval.openRubricModal('${pid}')">Evaluate</button>
              </div>
            </td>
          </tr>`;
                    }
                }).join('');

                document.getElementById('evalProjectTable').innerHTML = `
        <table>
          <thead><tr><th>Project</th><th>Team</th><th>School</th><th>Status</th><th>Action</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="5" class="muted" style="text-align:center;padding:20px">No projects assigned yet.</td></tr>'}</tbody>
        </table>`;

                const toolbar = document.getElementById('evalToolbar');
                toolbar.innerHTML = '';

                if (this._evaluatorFinalized()) {
                    toolbar.appendChild(U.el(`<div style="flex:1"></div>`));
                    const logoutBtn = U.el(`<button class="btn secondary">Logout</button>`);
                    logoutBtn.onclick = () => Auth.logoutEvaluator();
                    toolbar.appendChild(logoutBtn);
                    return;
                }

                const proceedBtn = U.el(`<button class="btn" id="proceedFinalizeBtn">Proceed to Finalize</button>`);
                proceedBtn.onclick = () => this.openFinalizeModal();
                const spacer = U.el(`<div style="flex:1"></div>`);
                const logoutBtn = U.el(`<button class="btn secondary">Logout</button>`);
                logoutBtn.onclick = () => Auth.logoutEvaluator();
                toolbar.appendChild(proceedBtn);
                toolbar.appendChild(spacer);
                toolbar.appendChild(logoutBtn);
            },

            openRubricModal(projectId) {
                const project = DB.projects.find(p => p.id === projectId) || { title: '(missing)' };
                const panel = DB.panels.find(p => p.projectIds.includes(projectId) && p.evaluatorIds.includes(Auth.currentEval.id));
                const prior = DB.results.find(r => r.projectId === projectId && r.evaluatorId === Auth.currentEval.id);
                const defs = DB.rubricDefs;
                const container = document.getElementById('modalContainer');
                container.innerHTML = '';

                const modal = U.el(`<div class="modal-wrap"><div class="modal" role="dialog" aria-modal="true" aria-label="Rubric: ${U.escape(project.title)}"></div></div>`);
                const modalInner = modal.querySelector('.modal');

                const fieldsHtml = defs.map(d => {
                    const val = prior ? (prior.scores?.[d.key] ?? '') : '';
                    return `<div style="margin-bottom:10px">
          <label>${U.escape(d.label)} <span class="muted">(0–10)</span></label>
          <input type="number" min="0" max="10" step="1" data-score="${U.escape(d.key)}" value="${U.escape(String(val))}">
          <div class="error hidden">Enter a value between 0 and 10.</div>
        </div>`;
                }).join('');

                modalInner.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
          <h2 style="margin:0;font-size:18px">${U.escape(project.title)}</h2>
          <div style="font-size:12px;color:var(--muted)">${U.escape(project.school || '')}</div>
        </div>
        <div class="hint" style="margin-bottom:12px">Team: ${U.escape(project.team || '—')} | Category: ${U.escape(project.category || '—')}</div>
        <div id="rubricFields">${fieldsHtml}</div>
        <label style="margin-top:8px">Overall Remark (optional)</label>
        <textarea id="rubricRemark" placeholder="Your comments about this project">${U.escape(prior ? prior.remark || '' : '')}</textarea>
        <div style="margin-top:12px" class="toolbar">
          <button class="btn" id="saveAndClose">Save & Close</button>
          <button class="btn" id="reviewBtn">Review</button>
          <button class="btn secondary" id="cancelRubric">Cancel</button>
        </div>
      `;
                container.appendChild(modal);

                this.draft = {
                    id: prior?.id || U.uid('result'),
                    panelId: panel?.id,
                    projectId: projectId,
                    evaluatorId: Auth.currentEval.id,
                    scores: prior?.scores ? { ...prior.scores } : {},
                    remark: prior?.remark || '',
                    total: prior?.total || 0,
                    ts: prior?.ts || Date.now(),
                    finalizedByEvaluator: prior?.finalizedByEvaluator || false
                };

                modal.querySelector('#cancelRubric').onclick = () => { modal.remove(); container.innerHTML = ''; };
                modal.querySelector('#reviewBtn').onclick = () => { this.prepareReviewFromModal(modal); };
                modal.querySelector('#saveAndClose').onclick = () => { this.saveFromModal(modal, true); };
                modal.querySelector('[data-score]')?.focus();
            },

            prepareReviewFromModal(modal) {
                const inputs = [...modal.querySelectorAll('[data-score]')];
                for (const inp of inputs) {
                    const v = Number(inp.value);
                    const err = inp.nextElementSibling;
                    if (isNaN(v) || v < 0 || v > 10) {
                        err.classList.remove('hidden');
                        alert('Please fix invalid scores (0–10 only).');
                        inp.focus();
                        return;
                    }
                    err.classList.add('hidden');
                    this.draft.scores[inp.dataset.score] = v;
                }
                this.draft.total = Object.values(this.draft.scores).reduce((a, b) => a + Number(b), 0);
                this.draft.remark = modal.querySelector('#rubricRemark').value.trim();

                modal.querySelector('.modal').innerHTML = `
        <h3>Review Your Scores</h3>
        <div class="card">
          <table>
            <thead><tr><th>Criterion</th><th>Score</th></tr></thead>
            <tbody>${Object.entries(this.draft.scores).map(([k, v]) => `<tr><td>${U.escape(DB.rubricDefs.find(d => d.key === k)?.label || k)}</td><td><b>${U.escape(String(v))}</b></td></tr>`).join('')}</tbody>
          </table>
          <p style="margin-top:12px;font-size:16px"><b>Total:</b> ${U.escape(String(this.draft.total))} / ${DB.rubricDefs.length * 10}</p>
          <p style="margin-top:8px"><b>Remark:</b> ${this.draft.remark ? U.escape(this.draft.remark) : '<span class="muted">none</span>'}</p>
        </div>
        <div style="margin-top:12px" class="toolbar">
          <button class="btn" id="confirmSubmit">Submit</button>
          <button class="btn secondary" id="editScores">Edit Scores</button>
          <button class="btn" id="saveDraft">Save Draft & Close</button>
        </div>
      `;
                modal.querySelector('#editScores').onclick = () => { modal.remove(); document.getElementById('modalContainer').innerHTML = ''; this.openRubricModal(this.draft.projectId); };
                modal.querySelector('#confirmSubmit').onclick = async () => { await this.submitDraft(); modal.remove(); document.getElementById('modalContainer').innerHTML = ''; this.goToAssigned(); };
                modal.querySelector('#saveDraft').onclick = () => { this.saveDraftOnly(); modal.remove(); document.getElementById('modalContainer').innerHTML = ''; this.goToAssigned(); };
            },

            saveFromModal(modal, closeAfterSave) {
                const inputs = [...modal.querySelectorAll('[data-score]')];
                for (const inp of inputs) {
                    const v = Number(inp.value);
                    const err = inp.nextElementSibling;
                    if (isNaN(v) || v < 0 || v > 10) {
                        err.classList.remove('hidden');
                        alert('Please fix invalid scores (0–10 only).');
                        inp.focus();
                        return;
                    }
                    err.classList.add('hidden');
                    this.draft.scores[inp.dataset.score] = v;
                }
                this.draft.total = Object.values(this.draft.scores).reduce((a, b) => a + Number(b), 0);
                this.draft.remark = modal.querySelector('#rubricRemark').value.trim();
                const existingIdx = DB.results.findIndex(r => r.id === this.draft.id);
                if (existingIdx >= 0) DB.results[existingIdx] = this.draft; else DB.results.push(this.draft);
                Store.save();
                if (closeAfterSave) {
                    modal.remove(); document.getElementById('modalContainer').innerHTML = ''; this.goToAssigned();
                }
            },

            saveDraftOnly() {
                const existingIdx = DB.results.findIndex(r => r.id === this.draft.id);
                if (existingIdx >= 0) DB.results[existingIdx] = this.draft; else DB.results.push(this.draft);
                Store.save();
            },

            async submitDraft() {
                if (!Auth.evalToken) {
                    alert('Session expired. Please log in again.');
                    Auth.logoutEvaluator();
                    return;
                }

                this.draft.ts = Date.now();

                try {
                    UI.showLoading('Submitting your evaluation...');

                    const data = await GASSync.call('saveResult', {
                        token: Auth.evalToken,
                        projectId: this.draft.projectId,
                        scores: this.draft.scores,
                        remark: this.draft.remark || '',
                        finalizedByEvaluator: true
                    });

                    UI.hideLoading();

                    // backend returns the saved result; use it as the source of truth
                    const saved = data.result;
                    const idx = DB.results.findIndex(r => r.id === saved.id);
                    if (idx >= 0) DB.results[idx] = saved;
                    else DB.results.push(saved);

                    Store.save();
                } catch (err) {
                    UI.hideLoading();
                    console.error(err);
                    alert('Error submitting evaluation: ' + err.message);
                }
            },


            openViewOnlyModalByProject(projectId) {
                const res = DB.results.find(r => r.projectId === projectId && r.evaluatorId === Auth.currentEval.id);
                if (!res) { alert('Submission not found'); return; }
                this.openViewOnlyModal(res);
            },

            openViewOnlyModal(res) {
                const project = DB.projects.find(p => p.id === res.projectId) || { title: '—' };
                const container = document.getElementById('modalContainer');
                const vmodal = U.el(`<div class="modal-wrap"><div class="modal" role="dialog" aria-modal="true" aria-label="View submission"></div></div>`);
                const defs = DB.rubricDefs;
                const rows = defs.map(d => `<tr><td>${U.escape(d.label)}</td><td><b>${U.escape(String(res.scores?.[d.key] ?? '—'))}</b></td></tr>`).join('');
                vmodal.querySelector('.modal').innerHTML = `
        <h3>Submission: ${U.escape(project.title)}</h3>
        <div class="hint" style="margin-bottom:12px">Team: ${U.escape(project.team || '—')} | School: ${U.escape(project.school || '—')}</div>
        <div class="card">
          <table>
            <thead><tr><th>Criterion</th><th>Score</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
          <p style="margin-top:12px;font-size:16px"><b>Total:</b> ${U.escape(String(res.total || 0))} / ${defs.length * 10}</p>
          <p style="margin-top:8px"><b>Remark:</b> ${res.remark ? U.escape(res.remark) : '<span class="muted">none</span>'}</p>
          <p style="margin-top:8px;color:var(--muted);font-size:13px">${res.finalizedByEvaluator ? '✓ Finalized' : 'Not Finalized'}</p>
        </div>
        <div style="margin-top:12px" class="toolbar">
          <button class="btn" id="closeView">Close</button>
        </div>
      `;
                container.appendChild(vmodal);
                vmodal.querySelector('#closeView').onclick = () => { vmodal.remove(); };
            },

            openFinalizeModal() {
                const subs = DB.results.filter(r => r.evaluatorId === Auth.currentEval.id);
                if (subs.length === 0) {
                    alert('No submissions yet. Submit at least one rubric before proceeding.');
                    return;
                }
                const container = document.getElementById('modalContainer');
                container.innerHTML = '';
                const modalWrap = U.el(`<div class="modal-wrap"></div>`);
                const modal = U.el(`<div class="modal" role="dialog" aria-modal="true" aria-label="Review submissions"></div>`);
                modalWrap.appendChild(modal);

                modal.innerHTML = `
        <h2>Review Your Submissions</h2>
        <div class="hint" style="margin-bottom:12px">Review all your evaluations before finalizing. Once finalized, you can only logout.</div>
        <div class="card" style="margin-bottom:12px">
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Project</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody>
                ${subs.map(s => `<tr data-resid="${U.escape(s.id)}">
                  <td><b>${U.escape(DB.projects.find(p => p.id === s.projectId)?.title || '—')}</b></td>
                  <td><b>${U.escape(String(s.total || 0))}</b></td>
                  <td>${s.finalizedByEvaluator ? '<span class="pill success">Finalized</span>' : '<span class="pill">Not Finalized</span>'}</td>
                  <td>
                    <div class="toolbar">
                      <button class="btn" data-view="${U.escape(s.id)}">View</button>
                      <button class="btn secondary" data-edit="${U.escape(s.id)}">Edit</button>
                    </div>
                  </td>
                </tr>`).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <div class="toolbar">
          <button class="btn" id="finalizeAllBtn">Finalize All Submissions</button>
          <button class="btn secondary" id="cancelFinalizeBtn">Cancel</button>
        </div>
      `;

                container.appendChild(modalWrap);

                modal.querySelectorAll('[data-view]').forEach(b => {
                    b.onclick = (e) => {
                        const rid = e.target.getAttribute('data-view');
                        const res = DB.results.find(r => r.id === rid);
                        this.openViewOnlyModal(res);
                    };
                });

                modal.querySelectorAll('[data-edit]').forEach(b => {
                    b.onclick = (e) => {
                        const rid = e.target.getAttribute('data-edit');
                        const res = DB.results.find(r => r.id === rid);
                        modalWrap.remove();
                        container.innerHTML = '';
                        this.openRubricModal(res.projectId);
                    };
                });

                modal.querySelector('#cancelFinalizeBtn').onclick = () => { modalWrap.remove(); container.innerHTML = ''; };

                modal.querySelector('#finalizeAllBtn').onclick = async () => {
                    if (!confirm('Click OK to finalize ALL your submissions. After finalizing, the screen will show only the Logout button.')) return;
                    subs.forEach(s => { s.finalizedByEvaluator = true; });
                    DB.evaluatorState = DB.evaluatorState || {};
                    DB.evaluatorState[Auth.currentEval.id] = DB.evaluatorState[Auth.currentEval.id] || {};
                    DB.evaluatorState[Auth.currentEval.id].finalizedAll = true;
                    Store.save();
                    if (DB.settings.gasUrl) { await GASSync.syncAll(); }
                    modalWrap.remove();
                    container.innerHTML = '';
                    this.goToAssigned();
                    alert('✓ All submissions finalized successfully!');
                };
            }
        };

        // Initialize
        UI.syncBranding();

        // Sample Data (only if empty)
        if (DB.projects.length === 0 && DB.evaluators.length === 0 && DB.panels.length === 0) {
            const p1 = { id: U.uid('project'), title: 'Smart Irrigation System', category: 'IoT', team: 'GreenTech', school: 'City High', contact: 'mentor@city.edu' };
            const p2 = { id: U.uid('project'), title: 'Air Quality Mapper', category: 'Environmental', team: 'ClearSkies', school: 'Sunrise School', contact: 'lead@sunrise.edu' };
            const p3 = { id: U.uid('project'), title: 'AI Waste Sorter', category: 'AI/ML', team: 'EcoBots', school: 'Riverdale', contact: 'lab@riverdale.edu' };
            DB.projects.push(p1, p2, p3);

            const e1 = { id: U.uid('evaluator'), name: 'Dr. A. Rao', email: 'rao@example.com', expertise: 'IoT', code: 123456 };
            const e2 = { id: U.uid('evaluator'), name: 'Ms. B. Shah', email: 'shah@example.com', expertise: 'AI/ML', code: 234567 };
            const e3 = { id: U.uid('evaluator'), name: 'Mr. C. Patel', email: 'patel@example.com', expertise: 'Enviro', code: 345678 };
            const e4 = { id: U.uid('evaluator'), name: 'Dr. D. Iyer', email: 'iyer@example.com', expertise: 'Robotics', code: 456789 };
            DB.evaluators.push(e1, e2, e3, e4);

            DB.panels.push({ id: U.uid('panel'), name: 'Panel 1', evaluatorIds: [e1.id, e2.id, e3.id], projectIds: [p1.id, p2.id, p3.id] });
            Store.save();
        }

        window.addEventListener('load', () => {
            if (Auth.currentEval) Eval.goToAssigned();
        });

        // Expose for inline onclick
        window.UI = UI;
        window.Auth = Auth;
        window.Admin = Admin;
        window.Eval = Eval;
    </script>

    <!-- 
  =====================================================
  GOOGLE APPS SCRIPT (GAS) BACKEND CODE
  =====================================================
  
  SETUP INSTRUCTIONS:
  1. Create a new Google Sheet
  2. Go to Extensions → Apps Script
  3. Delete any default code
  4. Copy and paste ALL the code below
  5. Click "Deploy" → "New deployment"
  6. Choose type: "Web app"
  7. Settings:
     - Execute as: Me
     - Who has access: Anyone
  8. Click "Deploy"
  9. Copy the Web App URL (ends with /exec)
  10. Paste in Admin Settings → GAS URL
  
  =====================================================
  -->

    <!--
  
  function doPost(e) {
  var output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);

  try {
    var body = JSON.parse(e.postData.contents || '{}');
    var action = body.action || body.type || 'unknown'; // keep backward compat with old "type"
    var result;

    if (action === 'bulk') {
      // legacy bulk sync (admin export)
      result = handleBulkSync(SpreadsheetApp.getActive(), body.data);
    } else {
      switch (action) {
        case 'loginEvaluator':
          result = loginEvaluator(body.email, String(body.code || ''));
          break;
        case 'saveResult':
          result = saveResult(body.token, body.projectId, body.scores, body.remark, body.finalizedByEvaluator);
          break;
        case 'getEvaluatorDashboard':
          result = getEvaluatorDashboard(body.token);
          break;
        default:
          result = { ok: false, error: 'Unknown action: ' + action };
      }
    }

    output.setContent(JSON.stringify(result));
    return output;
  } catch (err) {
    output.setContent(JSON.stringify({ ok: false, error: err.toString() }));
    return output;
  }
}

/**
 * Simple session management
 */
function saveSession(token, evaluatorId) {
  var ss = SpreadsheetApp.getActive();
  var sheet = ss.getSheetByName('Sessions') || ss.insertSheet('Sessions');
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(['Token', 'EvaluatorID', 'CreatedAt', 'ExpiresAt']);
  }
  var now = new Date();
  var expires = new Date(now.getTime() + 8 * 60 * 60 * 1000); // 8 hours
  sheet.appendRow([token, evaluatorId, now, expires]);
}

function getSession(token) {
  if (!token) return null;
  var ss = SpreadsheetApp.getActive();
  var sheet = ss.getSheetByName('Sessions');
  if (!sheet) return null;

  var data = sheet.getDataRange().getValues();
  var header = data[0];
  var rows = data.slice(1);

  var TOKEN_COL   = header.indexOf('Token');
  var EVAL_COL    = header.indexOf('EvaluatorID');
  var EXPIRES_COL = header.indexOf('ExpiresAt');

  for (var i = rows.length - 1; i >= 0; i--) {
    var row = rows[i];
    if (String(row[TOKEN_COL]) === String(token)) {
      var expires = row[EXPIRES_COL];
      if (expires && new Date(expires).getTime() < Date.now()) {
        return null; // expired
      }
      return {
        evaluatorId: row[EVAL_COL]
      };
    }
  }
  return null;
}

/**
 * Evaluator login with username/email validation
 */
function loginEvaluator(email, code) {
  email = String(email || '').trim();
  code  = String(code || '').trim();

  if (!email) {
    return { ok: false, error: 'Email is required.' };
  }
  if (!code) {
    return { ok: false, error: 'Access code is required.' };
  }

  // simple server-side email validation
  var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return { ok: false, error: 'Please enter a valid email address.' };
  }

  var ss = SpreadsheetApp.getActive();
  var evalSheet = ss.getSheetByName('Evaluators');
  if (!evalSheet) {
    return { ok: false, error: 'Evaluators sheet not found.' };
  }

  var data = evalSheet.getDataRange().getValues();
  var header = data[0];
  var rows = data.slice(1);

  var ID_COL    = header.indexOf('Evaluator ID');
  var NAME_COL  = header.indexOf('Name');
  var EMAIL_COL = header.indexOf('Email');
  var CODE_COL  = header.indexOf('Access Code');

  var evaluator = null;
  rows.forEach(function(row){
    if (!evaluator &&
        String(row[EMAIL_COL]).trim().toLowerCase() === email.toLowerCase() &&
        String(row[CODE_COL]).trim() === code) {
      evaluator = {
        id: row[ID_COL],
        name: row[NAME_COL],
        email: row[EMAIL_COL]
      };
    }
  });

  if (!evaluator) {
    return { ok: false, error: 'Invalid email or access code.' };
  }

  var token = Utilities.getUuid();
  saveSession(token, evaluator.id);

  var ctx = buildEvaluatorContext(evaluator.id);

  return {
    ok: true,
    token: token,
    evaluator: evaluator,
    context: ctx
  };
}

/**
 * Build evaluator context: their panels, projects, existing results
 */
function buildEvaluatorContext(evaluatorId) {
  var ss = SpreadsheetApp.getActive();

  var panelsSheet   = ss.getSheetByName('Panels');
  var projectsSheet = ss.getSheetByName('Projects');
  var resultsSheet  = ss.getSheetByName('Results');
  var evalSheet     = ss.getSheetByName('Evaluators');

  var panels   = [];
  var projects = [];
  var results  = [];
  var evaluators = [];

  if (evalSheet) {
    var evalData = evalSheet.getDataRange().getValues();
    var eh = evalData[0];
    var erows = evalData.slice(1);
    var E_ID  = eh.indexOf('Evaluator ID');
    var E_N   = eh.indexOf('Name');
    var E_E   = eh.indexOf('Email');
    var E_EX  = eh.indexOf('Expertise');
    var E_C   = eh.indexOf('Access Code');
    erows.forEach(function(r){
      evaluators.push({
        id: r[E_ID],
        name: r[E_N],
        email: r[E_E],
        expertise: r[E_EX],
        code: r[E_C]
      });
    });
  }

  // Panels
  if (panelsSheet) {
    var pData = panelsSheet.getDataRange().getValues();
    var ph = pData[0];
    var prows = pData.slice(1);

    var P_ID   = ph.indexOf('Panel ID');
    var P_NAME = ph.indexOf('Panel Name');
    var P_MEMN = ph.indexOf('Member Names');  // note: stored as text from your bulk sync
    var P_PRJN = ph.indexOf('Project Names'); // text
    // you might also have raw IDs in hidden columns if you want

    // For now, return all panels (frontend will still filter by evaluator)
    prows.forEach(function(r){
      panels.push({
        id: r[P_ID],
        name: r[P_NAME]
      });
    });
  }

  // Projects
  var projectMap = {};
  if (projectsSheet) {
    var projData = projectsSheet.getDataRange().getValues();
    var h = projData[0];
    var rows = projData.slice(1);
    var ID_COL  = h.indexOf('Project ID');
    var T_COL   = h.indexOf('Title');
    var C_COL   = h.indexOf('Category');
    var TEAM    = h.indexOf('Team');
    var SCHOOL  = h.indexOf('School');
    var CONTACT = h.indexOf('Contact');
    rows.forEach(function(r){
      var obj = {
        id: r[ID_COL],
        title: r[T_COL],
        category: r[C_COL],
        team: r[TEAM],
        school: r[SCHOOL],
        contact: r[CONTACT]
      };
      projects.push(obj);
      projectMap[obj.id] = obj;
    });
  }

  // Results (only those for this evaluator)
  if (resultsSheet) {
    var resData = resultsSheet.getDataRange().getValues();
    var rh = resData[0];
    var rrows = resData.slice(1);

    var R_ID    = rh.indexOf('Result ID') >= 0 ? rh.indexOf('Result ID') : rh.indexOf('ID');
    var R_PANEL = rh.indexOf('Panel ID');
    var R_PROJ  = rh.indexOf('Project ID');
    var R_EVAL  = rh.indexOf('Evaluator ID');
    var R_TOTAL = rh.indexOf('Total Score');
    var R_REM   = rh.indexOf('Remark');
    var R_FIN   = rh.indexOf('Finalized');
    var R_TS    = rh.indexOf('Timestamp');

    var S_PROB  = rh.indexOf('Problem (10)');
    var S_ORIG  = rh.indexOf('Originality (10)');
    var S_DESC  = rh.indexOf('Description (10)');
    var S_METH  = rh.indexOf('Method (10)');
    var S_IMP   = rh.indexOf('Impact (10)');
    var S_PRES  = rh.indexOf('Presentation (10)');

    rrows.forEach(function(r){
      if (String(r[R_EVAL]) !== String(evaluatorId)) return;

      var scores = {
        problem: r[S_PROB],
        originality: r[S_ORIG],
        description: r[S_DESC],
        method: r[S_METH],
        impact: r[S_IMP],
        presentation: r[S_PRES]
      };

      results.push({
        id: r[R_ID],
        panelId: r[R_PANEL],
        projectId: r[R_PROJ],
        evaluatorId: r[R_EVAL],
        total: r[R_TOTAL],
        remark: r[R_REM],
        finalizedByEvaluator: String(r[R_FIN]).toLowerCase() === 'yes',
        ts: r[R_TS],
        scores: scores
      });
    });
  }

  return {
    projects: projects,
    panels: panels,
    results: results,
    evaluators: evaluators
  };
}

/**
 * Save result with validation
 */
function saveResult(token, projectId, scores, remark, finalized) {
  var session = getSession(token);
  if (!session) {
    return { ok: false, error: 'Invalid or expired session. Please log in again.' };
  }

  var evaluatorId = session.evaluatorId;
  var ss = SpreadsheetApp.getActive();

  // basic validation
  scores = scores || {};
  var rubricKeys = ['problem', 'originality', 'description', 'method', 'impact', 'presentation'];
  var total = 0;
  rubricKeys.forEach(function(k){
    var v = Number(scores[k] || 0);
    if (isNaN(v) || v < 0 || v > 10) {
      throw new Error('Invalid score for ' + k + '. Must be between 0 and 10.');
    }
    total += v;
  });

  // TODO: optional: validate that evaluatorId is actually assigned to projectId via Panels sheet

  var resSheet = ss.getSheetByName('Results');
  if (!resSheet) {
    resSheet = ss.insertSheet('Results');
    resSheet.appendRow([
      'Result ID','Panel ID','Project ID','Evaluator ID',
      'Total Score','Remark','Finalized','Timestamp',
      'Problem (10)','Originality (10)','Description (10)',
      'Method (10)','Impact (10)','Presentation (10)'
    ]);
  }

  var resultId = 'RES-' + new Date().getTime(); // simple unique ID
  var now = new Date();

  resSheet.appendRow([
    resultId,
    '',            // panelId: optional, or derive from Panel assignment if you store it
    projectId,
    evaluatorId,
    total,
    remark || '',
    finalized ? 'Yes' : 'No',
    now,
    scores.problem,
    scores.originality,
    scores.description,
    scores.method,
    scores.impact,
    scores.presentation
  ]);

  return {
    ok: true,
    result: {
      id: resultId,
      panelId: '',
      projectId: projectId,
      evaluatorId: evaluatorId,
      total: total,
      remark: remark || '',
      finalizedByEvaluator: !!finalized,
      ts: now.getTime(),
      scores: scores
    }
  };
}

/**
 * Optional: API to reload context using token
 */
function getEvaluatorDashboard(token) {
  var session = getSession(token);
  if (!session) {
    return { ok: false, error: 'Invalid or expired session.' };
  }
  return {
    ok: true,
    context: buildEvaluatorContext(session.evaluatorId)
  };
}

/**
 * (Keep your existing handleBulkSync(...) from earlier, unchanged)
 */
function handleBulkSync(ss, data) {
  // ... you can keep the same implementation you already had ...
}

  
  -->

</body>

</html>